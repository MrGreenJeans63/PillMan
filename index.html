<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Pill Man — Meal Anchored</title>
<link href="https://fonts.googleapis.com/css2?family=Inter+Tight:wght@100;300;700&display=swap" rel="stylesheet">
<meta name="theme-color" content="#0b0f14"/>
<style>
  :root{
    --bg:#0b0f14; --fg:#e5f0ff; --muted:#8aa0b3;
    --ok:#4ce07a; --warn:#ffb74d; --bad:#ff4d4d;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial,sans-serif;
    display:flex;justify-content:center;align-items:center;
    -webkit-font-smoothing:antialiased;}
  .wrap{width:min(92vw,480px);display:flex;flex-direction:column;align-items:center;text-align:center;gap:14px;}
  .decision{display:flex;flex-direction:column;align-items:center;gap:8px;}
  .decision .answer{font-family:'Inter Tight',system-ui,sans-serif;font-weight:100;
    font-size:clamp(60px,18vw,100px);}
  .decision .label{font-size:12px;letter-spacing:.5px;color:var(--muted);}
  .timepair{display:flex;flex-direction:column;align-items:center;}
  .timepair .time{font-family:'Inter Tight',system-ui,sans-serif;font-weight:100;
    font-size:clamp(42px,12vw,72px);}
  .status{font-size:15px;}
  .ok{color:var(--ok);} .warn{color:var(--warn);} .bad{color:var(--bad);}
  .controls {
    display:flex;
    flex-wrap:nowrap;
    justify-content:center;
    gap:12px;
    margin-top:8px;
    width:100%;
    max-width:420px;
  }
  button {
    flex:1;
    height:46px;
    border:none;
    border-radius:8px;
    font-family:'Inter Tight',system-ui,sans-serif;
    font-weight:100;
    font-size:15px;
    cursor:pointer;
    color:#fff;
  }
  #btn_meal {
    background:#ff4d4d;
    color:#000; /* black text */
    font-weight:300; /* slightly thicker */
  }
  #btn_pill {
    background:#4ce07a;
    color:#000; /* black text */
    font-weight:300; /* slightly thicker */
  }
  #btn_edit_meal, #btn_edit_pill { background:#666; color:#fff; }
  .dataview{
    display:grid;
    grid-template-columns:1fr;
    width:100%;
    max-width:420px;
    margin-top:8px;
    font-size:13px;
    row-gap:4px;
  }
  .dataview .row{
    display:flex;
    justify-content:space-between;
    border-bottom:1px solid rgba(255,255,255,0.1);
    padding:2px 0;
  }
  .dataview .label{
    color:var(--muted);
    letter-spacing:.4px;
  }
  .dataview .val{
    font-family:'Inter Tight',system-ui,sans-serif;
    font-weight:100;
    color:var(--fg);
  }
  .dataview .val.ok { color: var(--ok); }
  .dataview .val.warn { color: var(--warn); }
  .dataview .val.bad { color: var(--bad); }
  .dataview .group{
    margin-top:8px;
    margin-bottom:4px;
    font-size:12px;
    font-weight:700;
    letter-spacing:.6px;
    color:var(--muted);
    border-bottom:1px solid rgba(255,255,255,0.12);
    padding-bottom:2px;
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="decision">
    <div class="answer" id="can_pill">—</div>
    <div class="label" id="decision_label">CAN I TAKE A PILL NOW?</div>
  </div>
  <div class="timepair">
    <div class="time" id="safe_time">—</div>
    <div class="label" id="safe_label">SAFE / EAT AGAIN AT</div>
  </div>
  <div class="status" id="status">Log a meal to begin.</div>
  <div class="dataview">
    <div class="group">EATING</div>
    <div class="row"><span class="label">LAST MEAL</span><span class="val" id="dev_last_meal">—</span></div>
    <div class="row"><span class="label">HOURS SINCE MEAL</span><span class="val" id="dev_since_meal">—</span></div>
    <div class="row"><span class="label">EAT AGAIN (IF PILL SOONEST)</span><span class="val" id="dev_eat_again">—</span></div>
    <div class="row"><span class="label">HOURS UNTIL NEXT MEAL</span><span class="val" id="dev_until_next_meal">—</span></div>
    <div class="row"><span class="label">HOURS LEFT TO EAT</span><span class="val" id="dev_hours_left">—</span></div>
    <div class="row"><span class="label">EST. NEXT MEAL</span><span class="val" id="dev_next_meal">—</span></div>

    <div class="group">PILL</div>
    <div class="row"><span class="label">SAFE PILL TIME</span><span class="val" id="dev_safe_pill">—</span></div>
    <div class="row"><span class="label">LAST PILL</span><span class="val" id="dev_last_pill">—</span></div>
    <div class="row"><span class="label">HOURS SINCE PILL</span><span class="val" id="dev_since_pill">—</span></div>
    <div class="row"><span class="label">HOURS UNTIL SAFE PILL</span><span class="val" id="dev_until_safe_pill">—</span></div>
    <div class="row"><span class="label">EST. NEXT PILL (MEAL)</span><span class="val" id="dev_est_next_pill">—</span></div>
    <div class="row"><span class="label">EST. GAP (LAST→NEXT)</span><span class="val" id="dev_est_gap">—</span></div>
  </div>
  <div class="controls">
    <button id="btn_meal">LOG MEAL</button>
    <button id="btn_pill">LOG PILL</button>
    <button id="btn_edit_meal">EDIT MEAL</button>
    <button id="btn_edit_pill">EDIT PILL</button>
  </div>
</div>

<script>
const H = 3600e3;
const $ = id => document.getElementById(id);
const two = n=>String(n).padStart(2,'0');
const showClock = ts => {
  if(!ts) return '—';
  const d=new Date(ts); let h=d.getHours(),m=d.getMinutes(),ap=h>=12?'PM':'AM'; h=h%12||12;
  return `${h}:${two(m)} ${ap}`;
};
const nowTS=()=>Date.now();
let LAST_MEAL_TS=null, LAST_PILL_TS=null;

function plan(){
  const now = nowTS();
  if (!LAST_MEAL_TS) return { state:'none', msg:'Log a meal to begin.' };

  const sinceMeal = (now - LAST_MEAL_TS) / H;
  const safeAfter = LAST_MEAL_TS + 2*H;           // earliest safe pill time (meal anchor)
  const pillLock  = (LAST_PILL_TS && now < (LAST_PILL_TS + 1*H));

  // Decide state and guidance message
  let state, msg;
  if (sinceMeal < 2) {
    state = 'bad';
    msg   = `Too soon after meal • Safe at ${showClock(safeAfter)}`;
  } else if (pillLock) {
    state = 'bad';
    msg   = `Post-pill lock • Eat again at ${showClock(LAST_PILL_TS + 1*H)}`;
  } else {
    state = 'ok';
    msg   = 'Safe to take pill';
  }

  // Eat Again = earliest time you could eat if you act at the soonest sensible moment from now
  let eatAgainAt = null;
  if (sinceMeal < 2) {
    // you cannot take a pill yet; earliest scenario: take pill at safeAfter → eat again 1h later
    eatAgainAt = safeAfter + 1*H;
  } else if (pillLock) {
    // you already took a pill; unlock is 1h after last pill
    eatAgainAt = LAST_PILL_TS + 1*H;
  } else {
    // you can take a pill now; eat again 1h from now if you do
    eatAgainAt = now + 1*H;
  }

  return { state, msg, safeAfter, eatAgainAt };
}

function render(){
  const r=plan();
  const ans=$('can_pill'), safe=$('safe_time'), status=$('status');
  if(r.state==='none'){ ans.textContent='—'; safe.textContent='—'; status.textContent=r.msg; return; }
  ans.textContent=(r.state==='ok')?'YES':'NO';
  ans.className='answer '+r.state;
  if(r.state==='ok'){
    safe.textContent=showClock(nowTS()+1*H);
    $('safe_label').textContent='EAT AGAIN AT';
  }else{
    safe.textContent=(r.state==='bad' && r.safeAfter)?showClock(r.safeAfter):'—';
    $('safe_label').textContent='SAFE AT';
  }
  status.textContent=r.msg;
  if ($('dev_last_meal')) {
    const now = nowTS();
    const lm  = LAST_MEAL_TS;
    const lp  = LAST_PILL_TS;
    const sinceMeal = lm ? (now - lm)/H : null;
    const sincePill = lp ? (now - lp)/H : null;
    const safePill  = lm ? (lm + 2*H) : null;              // meal anchor
    const nextMeal  = lm ? (lm + 4*H) : null;              // heuristic
    // const untilNextMeal = nextMeal ? (nextMeal - now)/H : null; // remove heuristic from the timing
    let untilNextMeal = null;
    // use eatAgainAt (earliest eat time if you act at soonest sensible moment)
    
    // Next safe pill must respect both meal (2h) and pill (8h) if last pill exists
    let nextSafePill = safePill;
    if (lp) nextSafePill = Math.max(nextSafePill, lp + 8*H);
    const untilSafePill = nextSafePill ? (nextSafePill - now)/H : null;

    // Eat Again (earliest if you act at soonest sensible moment now)
    let eatAgainAt = null;
    if (lm){
      if (sinceMeal < 2) {
        eatAgainAt = safePill + 1*H;             // take at safe, then +1h
      } else if (lp && now < (lp + 1*H)) {
        eatAgainAt = lp + 1*H;                   // post-pill lock
      } else {
        eatAgainAt = now + 1*H;                  // take now → eat in 1h
      }
    }
    // Hours until next possible meal is time until eatAgainAt
    if (eatAgainAt) {
      untilNextMeal = (eatAgainAt - now) / H;
    }

    // Hours left to eat: only during post‑pill lock; otherwise you can eat now (0.0 h)
    let hoursLeftEat = null;
    if (lp && now < (lp + 1*H)) {
      hoursLeftEat = (lp + 1*H - now) / H;  // countdown until eat OK
    } else if (lm) {
      hoursLeftEat = 0.0;                   // not in a post‑pill lock → free to eat
    }

    // Estimated next pill if you eat at the earliest possible time (eatAgainAt)
    const estNextPillFromMeal = eatAgainAt ? (eatAgainAt + 2*H) : null;
    const estGap = (sincePill!=null && untilNextMeal!=null)
      ? Math.max(0, sincePill) + Math.max(0, untilNextMeal) + 2
      : null;

    // helper to classify gap color
    const gapClass = (h) => {
      if (h == null) return '';
      const v = Math.max(0, h);
      if (v >= 7 && v <= 9) return 'ok';
      if ((v >= 5 && v <= 6) || (v >= 10 && v <= 11)) return 'warn';
      if (v <= 4 || v >= 12) return 'bad';
      return '';
    };

    // Bind
    $('dev_last_meal').textContent     = lm ? showClock(lm) : '—';
    $('dev_since_meal').textContent    = (sinceMeal!=null) ? `${Math.max(0,sinceMeal).toFixed(1)} h` : '—';
    $('dev_safe_pill').textContent     = safePill ? showClock(safePill) : '—';
    $('dev_next_meal').textContent     = nextMeal ? showClock(nextMeal) : '—';
    $('dev_until_next_meal').textContent = (untilNextMeal!=null) ? `${(untilNextMeal).toFixed(1)} h` : '—';
    $('dev_eat_again').textContent     = eatAgainAt ? showClock(eatAgainAt) : '—';
    $('dev_hours_left').textContent    = (hoursLeftEat!=null) ? `${hoursLeftEat.toFixed(1)} h` : '—';
    $('dev_last_pill').textContent     = lp ? showClock(lp) : '—';
    $('dev_since_pill').textContent    = (sincePill!=null) ? `${Math.max(0,sincePill).toFixed(1)} h` : '—';
    $('dev_next_safe_pill').textContent= nextSafePill ? showClock(nextSafePill) : '—';
    $('dev_until_safe_pill').textContent= (untilSafePill!=null) ? `${(untilSafePill).toFixed(1)} h` : '—';
    $('dev_est_next_pill').textContent = estNextPillFromMeal ? showClock(estNextPillFromMeal) : '—';
    $('dev_est_gap').textContent       = (estGap!=null) ? `${estGap.toFixed(1)} h` : '—';

    // After binding values, colorize HOURS SINCE PILL and EST. GAP
    const spEl = $('dev_since_pill');
    if (spEl) {
      spEl.classList.remove('ok','warn','bad');
      const cls = gapClass(sincePill);
      if (cls) spEl.classList.add(cls);
    }
    const egEl = $('dev_est_gap');
    if (egEl) {
      egEl.classList.remove('ok','warn','bad');
      const cls2 = gapClass(estGap);
      if (cls2) egEl.classList.add(cls2);
    }
  }
}

function parseClockInput(t){ if(!t) return null; const s=String(t).trim(); const d=new Date();
  if(s.includes(':')){const[Hh,Mm='0']=s.split(':'); d.setHours(+Hh,+Mm,0,0); return d.getTime();}
  const hh=+s;if(isNaN(hh))return null; d.setHours(hh,0,0,0); return d.getTime();
}

function wire(){
  $('btn_meal').onclick=()=>{LAST_MEAL_TS=nowTS();render();};
  $('btn_pill').onclick=()=>{LAST_PILL_TS=nowTS();render();};
  $('btn_edit_meal').onclick=()=>{const inp=prompt('Last meal (HH or HH:MM)?');const ts=parseClockInput(inp);if(ts){LAST_MEAL_TS=ts;render();}};
  $('btn_edit_pill').onclick=()=>{const inp=prompt('Last pill (HH or HH:MM)?');const ts=parseClockInput(inp);if(ts){LAST_PILL_TS=ts;render();}};
}

document.addEventListener('DOMContentLoaded',()=>{wire();render();setInterval(render,15000);});
</script>
</body>
</html>
